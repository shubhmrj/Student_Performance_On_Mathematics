name: Deploy to Elastic Beanstalk

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Install zip
      run: sudo apt-get update && sudo apt-get install -y zip

    - name: Create app archive
      run: |
        # create a clean zip of the repository HEAD (excludes .git)
        git archive -o app.zip HEAD
        echo "ZIP created: $(ls -lh app.zip)"

    - name: Upload to S3
      env:
        S3_BUCKET: ${{ secrets.EB_S3_BUCKET }}
        VERSION_LABEL: v-${{ github.run_number }}-${{ github.sha }}
      run: |
        if [ -z "$S3_BUCKET" ]; then
          echo "ERROR: EB_S3_BUCKET secret is not set"; exit 1
        fi
        S3_KEY="releases/${VERSION_LABEL}.zip"
        aws s3 cp app.zip s3://${S3_BUCKET}/${S3_KEY}
        echo "s3://$S3_BUCKET/$S3_KEY uploaded"
        echo "S3_KEY=$S3_KEY" >> $GITHUB_OUTPUT
        echo "VERSION_LABEL=$VERSION_LABEL" >> $GITHUB_OUTPUT

    - name: Create Elastic Beanstalk application version
      id: create_app_version
      env:
        APPLICATION_NAME: ${{ secrets.EB_APPLICATION_NAME }}
        S3_BUCKET: ${{ secrets.EB_S3_BUCKET }}
        S3_KEY: ${{ steps.Upload_to_S3.outputs.S3_KEY || '' }}
        VERSION_LABEL: ${{ github.run_number }}-${{ github.sha }}
      run: |
        if [ -z "$APPLICATION_NAME" ]; then
          echo "ERROR: EB_APPLICATION_NAME secret is not set"; exit 1
        fi
        # Use the S3 key stored earlier
        S3_KEY="releases/v-${{ github.run_number }}-${{ github.sha }}.zip"
        VERSION_LABEL="v-${{ github.run_number }}-${{ github.sha }}"
        aws elasticbeanstalk create-application-version \
          --application-name "$APPLICATION_NAME" \
          --version-label "$VERSION_LABEL" \
          --source-bundle S3Bucket=${S3_BUCKET},S3Key=${S3_KEY} \
          --auto-create-application
        echo "VERSION_LABEL=$VERSION_LABEL" >> $GITHUB_OUTPUT

    - name: Deploy application version to environment
      env:
        ENV_NAME: ${{ secrets.EB_ENVIRONMENT_NAME }}
        APP_NAME: ${{ secrets.EB_APPLICATION_NAME }}
        VERSION_LABEL: ${{ steps.create_app_version.outputs.VERSION_LABEL }}
      run: |
        if [ -z "$ENV_NAME" ]; then
          echo "ERROR: EB_ENVIRONMENT_NAME secret not set"; exit 1
        fi
        echo "Updating environment $ENV_NAME to version $VERSION_LABEL"
        aws elasticbeanstalk update-environment \
          --environment-name "$ENV_NAME" \
          --version-label "$VERSION_LABEL"

    - name: Wait for environment update (poll, timeout 15m)
      env:
        ENV_NAME: ${{ secrets.EB_ENVIRONMENT_NAME }}
      run: |
        echo "Waiting for environment to be updated and healthy..."
        end=$((SECONDS+900))
        while [ $SECONDS -lt $end ]; do
          aws elasticbeanstalk describe-environments --environment-names "$ENV_NAME" --query 'Environments[0].{Status:Status,Health:Health}' --output json
          STATUS=$(aws elasticbeanstalk describe-environments --environment-names "$ENV_NAME" --query 'Environments[0].Status' --output text)
          HEALTH=$(aws elasticbeanstalk describe-environments --environment-names "$ENV_NAME" --query 'Environments[0].Health' --output text)
          echo "Status=$STATUS, Health=$HEALTH"
          if [ "$STATUS" = "Ready" ] && [ "$HEALTH" = "Green" ]; then
            echo "Environment is Ready and Green"
            exit 0
          fi
          sleep 15
        done
        echo "Timed out waiting for environment to become healthy"; aws elasticbeanstalk describe-environments --environment-names "$ENV_NAME"; exit 1
